---
title: "Biodiversity Information Review & Decision Support with Citizen Science data"
subtitle: "BIO8068 Data visualisation in Ecology"
output:
  word_document:
    reference_docx: word_template.docx
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rgbif)
library(rinat)
library(NBN4R)
library(ggplot2)
library(dplyr)
library(lubridate)
library(BIRDS)
library(sp)
library(sf)
```

# What is Biodiversity Information Review & Decision Support (BIRDS)?
You have already seen how to download citizen science data from a variety of databases, and identified some of the problems that may occur. But how do you know whether the citizen science data is "fit-for-use" for subsequent visualisation and modelling? `BIRDS` is an R package that will help you identify potential under- or over-reporting of species in particular areas, detect anomalous records etc. as well as help you in your decision-making when using citizen science data.

This practical aims to provide an overview of some of the basic functionality of BIRDS, and some typical workflows, using data from the NBN Atlas dataset. Note that despite its name, BIRDS can be used on any taxonomic group! The concepts behind BIRDS were originally published in three papers over the last 20 years, although the package itself is very new:

* Ruete A. (2015) Displaying bias in sampling effort of data accessed from biodiversity databases using ignorance maps. Biodiversity Data Journal <https://doi.org/10.3897/BDJ.3.e5361>
* Szabo J.K. _et al_ (2010) Regional avian species declines estimated from volunteer-collected long-term data using List Length Analysis. Ecological Applications <https://doi.org/10.1890/09-0877.1>
* Tefler M.G. _et al_ (2002) A general method for measuring relative change in range size from biological atlas data. Biological Conservation <https://doi.org/10.1016/S0006-3207(02)00050-2>

# Getting started with BIRDS
Begin by installing and loading the BIRDS package in the usual way with `install.packages("BIRDS")`. Note that it will auto-install various other packages at the same time. Please load the BIRDS library, as well as several other useful ones, such as `NBN4R` to get the data, the `sp` and `sf` packages for handling spatial information, and the `lubridate` package for handling dates and times.

```{r, eval=FALSE}
library(BIRDS)
library(NBN4R)
library(sp)
library(sf)
library(lubridate)
```

# Sundews _Drosera_ in Scotland
As our example to demonstrate how to use BIRDS, we will look at Citizen Science data on fly-catches or sundews, in Scotland. Sundews belong to the genus _Drosera_ and there are several different species in the UK. They tend to occur in upland bogs, where the soil is poor in nitrogen and other key nutrients, and the plants have evolved sticky hairs on their leaves with which to catch insects, and in thus increase their supply of nutrients.

```{r, eval=FALSE}
nbn_config(caching="off")
drosera_nbn <- ALA4R::occurrences(taxon="Drosera",
                                  download_reason_id=4,
                                  verbose=TRUE,
                                  email="your.email@newcastle.ac.uk")

# If the download fails, use GBIF, or this drosera_nbn.RDS file from Canvas
# drosera_nbn <- readRDS("drosera_nbn.RDS")
```

```{r, echo=FALSE}
# nbn_config(caching="off")
# drosera_nbn <- ALA4R::occurrences(taxon="Drosera anglica", download_reason_id=4,
#                                  verbose=TRUE,
#                                  email="your.email@newcastle.ac.uk")
drosera_nbn <- readRDS("drosera_nbn.RDS")
```

Remember that the downloaded data is in the form of an R "list", with two sections in it, `$data` and a `$meta` section, with additional information about sources. For example type `View(drosera_nbn$meta$citation)` to see information about the recording schemes. You can check the scientific names with:

```{r}
unique(drosera_nbn$data$scientificName)
```

and you can see that there are several species, some hybrids, and some records only recorded to genus-level. To make subsequent analyses easier, we'll put the `drosera_nbn$data` dataframe into a dataframe of its own, so that you no longer have to use multiple `$` symbols to address a list structure. We'll call it `PBD` to indicate "primary biodiversity data" which is the syntax used by BIRDS. We'll then clean up the data, to:

* remove records without longitude or latitude information
* remove records without information on the recording date
* remove records without information about the locality (used by BIRDS)
* remove records without information on the recorder (again, this is used by BIRDS)
* keep records identified to the `rank` of species, and not merely genus
* keep records from 1970 onwards. We  Some records go back to the 19th century, and they are likely to skew our analyses.

In the lines of code below, remember that

* `!` represents "not"
* `|` represents "or"
* `!=` represents "not equal"
* `==` represents "equals"
* `>=` represents "greater than or equals"

Note that before the closing square bracket there is a comma `,]` to indicate that all columns in the dataframe should be retained:

```{r}
PBD <- drosera_nbn$data
PBD <- PBD[!is.na(PBD$longitudeWGS84) | !is.na(PBD$latitudeWGS84) ,]
PBD <- PBD[PBD$startDate != "" ,]
PBD <- PBD[PBD$locality  != "" ,]
PBD <- PBD[PBD$recorder  != "" ,]
PBD <- PBD[PBD$rank      == "species" ,] # This can be done via organizeBirds
PBD <- PBD[PBD$startDateYear >= 1970 ,]
```

# Field visits and the OrganizedBirds class
A central concept in BIRDS is what is known as an `OrganizedBirds` class. This makes it easier to assess visits by the same or different observers over time to different sites or localities. Hence, when we cleaned the data, we had to ensure that localities and recorder information was available. A “visit” define the sampling unit as a sampling event by a unique observer (or group of observers), at a unique unit of space and time (commonly a day). Visits can help us to summarize the amount of effort expended in the field. During a visit, the observer commonly samples (i.e. observes and records) species by similar methods. The sampling effort can vary among visits, with the amount of effort expended being greater when spending more time, and reporting more of the observed species. The same number of observations (records of species) at a unique unit of time and space could be made by either few observers reporting many species (greater effort by each observer) or many observers reporting few species (small effort by each observer). Using visits as sampling units allows separation of sampling effort into the effort that can be expressed through the number of visits by different observers and the effort per visit (e.g. species list length, or when available the time spent during a visit). Hence, the quality (completeness) of the data can be judged by using information for each visit and information from a collection of visits.

To create our `OB` object simply use the `organizeBirds()` function. By default quite a lot of information is printed to screen as it processes the data, but don't worry about that. 

```{r, results="hide"}
OB <- organizeBirds(PBD,
                    sppCol = "scientificName",
                    simplifySppName = TRUE,  # Removes authors and years etc.
                    idCols = c("locality", "recorder"),
                    xyCols = c("longitudeWGS84", "latitudeWGS84"),
                    timeCols = "startDate")
```

We can then create a 25km grid for Scotland on which to explore the data; this should be the maximum sized area that a person might explore in a day (this differs for different taxonomic groups). By default it is set at 10 km, but as this will slow down calculations for a large area like Scotland, I'll slightly increase it to 25km which is still not unrealistic. 

```{r}
gb_ll_sf <- readRDS("gb_simple.RDS")
scot_ll_sf <- gb_ll_sf[2,]  # Scotland is coded number 2 in the GB map used
scot_ll_sp <- as_Spatial(scot_ll_sf) # Expects polygon in sp rather than sf format

scot_grid <- makeGrid(scot_ll_sp, 25)
plot(scot_grid)
```

You can see that it actually creates a series of **hexagonal** grids packed together, which is more convenient when analysing the species occurence data. You can then summarise the `OB` object against this grids to show how the number of visits varies. Records in England and Wales are omitted:

```{r}
SB <- summariseBirds(OB, grid=scot_grid)
```

Once you have obtained this summarised data object `SB` you can then interrogate it, for example using `exposeIgnorance()` to highlight any areas of particular concern (there are none in this case). A particularly useful function is to look at changes across years, months, and space, all in one plot for a given species:

```{r}
all_species <- listSpecies(SB)
all_species
focal_species <- all_species[1] # Let's pick Drosera anglica
focalSpReport(SB, focalSp=focal_species)
```

The map shows the hexagons that were visited, shaded according to whether the _Drosera anglica_ was detected. Note that not all hexagons are present (compare with earlier map), in that a small number were not visited at all. You can also obtain useful information about how long, and over how many months, each species was observed in tabular form:

```{r, eval=FALSE}
drosera_summary <- speciesSummary(SB)
View(SB)
```

You can export information from your `SB` object to plot changes over time. For example, a useful static is the number of observations relative to the number of visits, which we will sum for each year:

```{r}
# Look at some summarised variables:
# Number of observations
EBnObs <- exportBirds(SB, dimension = "temporal", timeRes = "yearly", 
                      variable = "nObs", method = "sum")
# Number of visits
EBnVis <- exportBirds(SB, dimension = "temporal", timeRes = "yearly", 
                      variable = "nVis", method = "sum")
# The ratio of number of observations over number of visits
relObs <- EBnObs/EBnVis
```


```{r}
# Average species list length (SLL) per year (a double-average, i.e. the mean 
# over cell values for the median SLL from all visits per year and cell) 
EBavgSll <- colMeans(SB$spatioTemporal[,,"Yearly","avgSll"], na.rm = TRUE)

# Set the result to a time-series object
EBavgSll <- xts::xts(EBavgSll, date(relObs))
```

Now let's create some simple plots to view patterns over time:

```{r}
# column-bind the observations and visits
obs_visits <- cbind(EBnObs, EBnVis)

# plot(obs_visits)                   # Default time-series plot
autoplot(obs_visits, facet=NULL) +   # ggplot2-compatible
  xlab("Year") +
  ylab("Observations or visits")
```

You can readily see that the numbers of observations of sundews is very highly correlated with the numbers of visits made to the locations across Scotland over time. This is easy to confirm by scaling the number of observations divided by the number of visits, and checking that this is relatively constant over time:

```{r}
autoplot(relObs) +
  xlab("Year") +
  ylab("Relative observations by visit")
```

You can see that other than a slight peak around 1990 and 1992, the numbers of observations per visit have remained relatively constant over time. Now let's look at the average species list length per cell:

```{r}
autoplot(EBavgSll) +
  xlab("Year") +
  ylab("Average species list length per cell ")
```

This is quite a small dataset (deliberately, to speed up data processing for you), so keep in mind that there are only 6 species of _Drosera_ in the dataset, of which only two a widespread. Therefore, don't be suprised that the average species list length is low. What matters are changes over time, and you can see that this is generally increasing, which is good. Ignore the sudden drop-off in 2019-20, suggesting the most recent datasets have not been fully uploaded.

## Mapping frequency with which areas were visited


```{r}
wNonEmpty<-unname( which( unlist(lapply(SB$overlaid, nrow)) != 0) )
EB <- exportBirds(SB, "Spatial", "Month", "nYears", "sum")
# because the dimension is "spatial", the result is a 'SpatialPolygonDataFrame'

palBW <- leaflet::colorNumeric(c("white", "navyblue"), 
                               c(0, max(EB@data, na.rm = TRUE)), 
                               na.color = "transparent")
oldpar <- par(no.readonly =TRUE)
par(mfrow=c(1,3), mar=c(1,1,1,1))
plot(SB$spatial[wNonEmpty,], col="grey", border = NA)
plot(scot_ll_sp, col=NA, border = "grey", lwd=1, add=TRUE)
mtext("Visited cells", 3, line=-1)

plot(EB, col=palBW(EB@data$Jul), border = NA)
plot(scot_ll_sp, col=NA, border = "grey", lwd=1, add=TRUE)
mtext("Number of years for which \nJuly was sampled", 3, line=-2)

plot(EB, col=palBW(EB@data$Dec), border = NA)
plot(scot_ll_sp, col=NA, border = "grey", lwd=1, add=TRUE)
mtext("Number of years for which \nDecember was sampled", 3, line=-2)
legend("bottomleft", 
       legend=seq(0, max(EB@data, na.rm = TRUE), length.out = 5),
       col = palBW(seq(0, max(EB@data, na.rm = TRUE), length.out = 5)),
       title = "Number of years", pch = 15, bty="n")
par(oldpar)
```


```{r}
oldpar <- par(no.readonly =TRUE)
par(mfrow=c(1,2), mar=c(1,1,1,1))
palBW <- leaflet::colorNumeric(c("white", "navyblue"), 
                               c(0, max(SB$spatial@data$nVis, na.rm = TRUE)), 
                               na.color = "transparent")
seqNVis<-round(seq(0, max(SB$spatial@data$nVis, na.rm = TRUE), length.out = 5))
plot(SB$spatial, col=palBW(SB$spatial@data$nVis), border = NA)
plot(scot_ll_sp, col=NA, border = "grey", lwd=1, add=TRUE)
legend("bottomleft", legend=seqNVis, col = palBW(seqNVis),
      title = "Number of \nobservations", pch = 15, bty="n")

ign<-exposeIgnorance(SB$spatial@data$nVis, h = 5)
palBWR <- leaflet::colorNumeric(c("navyblue", "white","red"), c(0, 1), 
                                na.color = "transparent")
plot(scot_ll_sp, col="grey90", border = "grey90", lwd=1)
#> Warning in wkt(obj): CRS object has no comment
plot(SB$spatial, col=palBWR(ign), border = NA, add=TRUE)
plot(scot_ll_sp, col=NA, border = "grey", lwd=1, add=TRUE)
legend("bottomleft", legend=c(seq(0, 1, length.out = 5), "NA"),
      col = c(palBWR(seq(0, 1, length.out = 5)), "grey90"),
      title = "Ignorance \nnVis, \nO0.5=5", pch = 15, bty="n")
par(oldpar)
```


